<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Happy Birthday Vathanakvann Rin! üéÇ üéà</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root { --primary: #facc15; --bg: #0f172a; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: #e5e7eb; text-align: center; overflow: hidden; height: 100vh; user-select: none; }

/* --- Gift Screen --- */
#giftScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); z-index: 200; cursor: pointer; }
.gift { font-size: 120px; animation: pulse 1.5s infinite ease-in-out; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); rotate(5deg); } }

/* --- Main Content --- */
#content { display: none; height: 100vh; width: 100%; align-items: center; justify-content: center; position: relative; }

.card-container {
    position: relative;
    padding: 25px;
    background-image: url('test.jpg'); 
    background-size: cover;
    background-position: center;
    border-radius: 45px;
    box-shadow: 0 10px 60px rgba(0,0,0,0.8);
    z-index: 10; 
}

.card {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 35px;
    padding: 40px 30px;
    max-width: 380px;
}

h1 { font-family: 'Dancing Script', cursive; color: var(--primary); font-size: 2.8rem; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
h2 { font-weight: 300; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

/* --- Big Cake --- */
.cake-wrapper { position: relative; display: inline-block; cursor: pointer; margin: 20px 0; z-index: 20; }
#cake { font-size: 140px; animation: bounce 2s infinite; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); }
@keyframes bounce { 50% { transform: translateY(-15px); } }
#flame { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); font-size: 55px; animation: flicker 0.3s infinite alternate; filter: drop-shadow(0 0 10px orange); }
@keyframes flicker { from { opacity: 0.8; transform: translateX(-50%) scale(1); } to { opacity: 1; transform: translateX(-50%) scale(1.15); } }
.flame-off { display: none; }

/* --- Balloon Game Styling --- */
.balloon {
    position: absolute;
    bottom: -120px;
    width: 70px;
    height: 95px;
    border-radius: 50%;
    cursor: crosshair; /* Changes cursor to target */
    z-index: 100; /* Ensure balloons are on top of everything */
    box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1);
    /* No transition here, we use animation for popping now */
}
/* String for balloon */
.balloon::after { content: ""; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); width: 2px; height: 25px; background: rgba(255,255,255,0.6); }

/* The attractive pop animation */
@keyframes popExplosion {
    0% { transform: scale(1); filter: brightness(1); }
    40% { transform: scale(1.3) rotate(15deg); filter: brightness(2); opacity: 0.9; }
    100% { transform: scale(0.5); opacity: 0; filter: brightness(3); }
}

.balloon-popped {
    animation: popExplosion 0.3s ease-out forwards;
    pointer-events: none; /* Cannot click again during animation */
}

/* Score Board */
#scoreBoard {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 1.3rem;
    color: var(--primary);
    font-weight: bold;
    z-index: 300;
    display: none; /* Hidden until game starts */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(250, 204, 21, 0.3);
}

.wishing-text { display: none; margin-top: 25px; font-style: italic; animation: fadeIn 1s forwards; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.controls { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 30px; z-index: 300; display: flex; align-items: center; gap: 8px;}
input[type=range] { accent-color: var(--primary); cursor: pointer; }
</style>
</head>

<body>

<audio id="music" preload="auto" loop>
  <source src="happy-birthday-357371.mp3" type="audio/mp3">
</audio>

<audio id="popSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mp3">
</audio>

<div class="controls">
    <span style="font-size:14px">üéµ</span>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
</div>

<div id="scoreBoard">Score: 0 üéà</div>

<div id="giftScreen" onclick="openGift()">
    <div class="gift">üéÅ</div>
    <p>A gift for <b>Vathanakvann Rin</b></p>
    <p style="font-size: 12px; opacity: 0.6; margin-top: 5px;">(Tap to Open)</p>
</div>

<div id="content">
  <div class="card-container">
      <div class="card">
        <div class="cake-wrapper" onclick="blowCandle()">
          <div id="flame">üî•</div>
          <div id="cake">üéÇ</div>
        </div>
        <h1>Happy Birthday</h1>
        <h2>Vathanakvann Rin</h2>
        
        <div id="wishMessage" class="wishing-text">
            <p style="font-size: 1.1rem;">"Wishing you the happiest of birthdays and an incredible year ahead!"</p>
            <p style="color: var(--primary); font-family: 'Dancing Script'; font-size: 1.6rem; margin-top: 15px;">‚Äî Pop the balloons! üéà</p>
        </div>
        <p class="note" id="instruction" style="margin-top: 20px; opacity: 0.8; font-size: 14px;">Blow into your mic or tap the cake! üé§üí®</p>
      </div>
  </div>
</div>

<script>
let blown = false;
let score = 0; 
const audio = document.getElementById("music");
const popSound = document.getElementById("popSound");
const scoreBoard = document.getElementById("scoreBoard");

// 1. IMPROVED: Prime the sound immediately on the first click
function openGift() {
  document.getElementById("giftScreen").style.display = "none";
  document.getElementById("content").style.display = "flex";
  
  // Start background music
  audio.play().catch(e => console.log("Music blocked"));

  // UNLOCK POP SOUND: We play and immediately pause it 
  // This tells the browser: "The user said it's okay for this sound to play later."
  popSound.play().then(() => {
      popSound.pause();
      popSound.currentTime = 0;
  }).catch(e => console.log("Pop sound priming failed"));

  startMic();
}

function blowCandle() {
  if (blown) return;
  blown = true;

  audio.pause(); 

  document.getElementById("flame").classList.add("flame-off");
  document.getElementById("instruction").style.display = "none";
  document.getElementById("wishMessage").style.display = "block";
  scoreBoard.style.display = "block";

  setInterval(createBalloon, 700);
}

function createBalloon() {
    const b = document.createElement("div");
    b.className = "balloon";
    const colors = ['#ff5e57', '#0be881', '#3c40c6', '#ffd32a', '#ff3f34', '#0fb9b1'];
    b.style.background = `radial-gradient(circle at 30% 30%, ${colors[Math.floor(Math.random() * colors.length)]}, #000)`;
    b.style.left = (Math.random() * 85 + 5) + "vw";
    
    b.onclick = function() {
        // 2. IMPROVED: Use a simpler play method for better compatibility
        const playPromise = popSound.cloneNode(true).play();
        if (playPromise !== undefined) {
            playPromise.catch(() => {
                // If it fails, try playing the original directly
                popSound.play();
            });
        }

        score++;
        scoreBoard.innerHTML = "Score: " + score + " üéà";
        this.classList.add("balloon-popped");
        setTimeout(() => this.remove(), 300);
    };

    document.body.appendChild(b);

    let pos = -120;
    const speed = Math.random() * 1.5 + 1;
    const interval = setInterval(() => {
        if (pos > window.innerHeight + 150) {
            clearInterval(interval);
            if (b.parentNode) b.remove();
        } else {
            pos += speed;
            b.style.bottom = pos + "px";
        }
    }, 16);
}

document.getElementById("volumeSlider").addEventListener("input", (e) => {
    audio.volume = e.target.value;
});

function startMic() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const ctx = new AudioContext();
    const mic = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser();
    mic.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    function listen() {
      analyser.getByteFrequencyData(data);
      const volume = data.reduce((a,b)=>a+b)/data.length;
      if (volume > 55 && !blown) blowCandle();
      if (!blown) requestAnimationFrame(listen);
    }
    listen();
  }).catch(()=>{});
}
</script>
</body>
</html>
